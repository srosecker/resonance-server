# Resonance Legacy Transcoding Configuration
# ==========================================
#
# This file defines transcoding rules for legacy Squeezebox hardware that
# cannot decode certain audio formats natively (e.g., MP4 containers).
#
# Format:
#   <source_format> <dest_format> <device_type> <device_id>
#   <command_line>
#
# Where:
#   source_format:  File extension without dot (mp4, m4a, m4b, alac, etc.)
#   dest_format:    Output format (flac, pcm, mp3, aac)
#   device_type:    Device type or * for all (slimp3, squeezebox, boom, *)
#   device_id:      MAC address or * for all
#
# Command line placeholders:
#   $FILE$     - Absolute path to the source file
#   $START$    - Seek start position (replaced with "-j <seconds>" or empty)
#   $END$      - Seek end position (replaced with "-e <seconds>" or empty)
#   [binary]   - Executable name (resolved from third_party/bin/)
#   -          - Passthrough (no transcoding needed)
#
# Capabilities flags (in comment before command):
#   # F         - Can read from file
#   # I         - Can read from stdin
#   # T         - Supports time-based seeking (START/END)
#
# The first matching rule wins (more specific rules should come first).

# =============================================================================
# MP4 Container Formats (M4A, M4B, MP4)
# =============================================================================
# Legacy hardware cannot parse MP4/MOV container format.
# We extract raw audio using faad.

# M4B (Audiobooks) -> MP3 (fast start / LMS-like)
m4b mp3 * *
	# FT
	[faad] -q -w -f 1 $START$ $END$ $FILE$ | [lame] --silent -q 2 - -

# M4B -> PCM (fallback if FLAC not supported)
m4b pcm * *
	# FT
	[faad] -q -w -f 2 -b 1 $START$ $END$ $FILE$

# M4A (AAC in MP4) -> MP3 (fast start / LMS-like)
m4a mp3 * *
	# FT
	[faad] -q -w -f 1 $START$ $END$ $FILE$ | [lame] --silent -q 2 - -

# M4A -> PCM (fallback)
m4a pcm * *
	# FT
	[faad] -q -w -f 2 -b 1 $START$ $END$ $FILE$

# MP4 (generic) -> MP3 (fast start / LMS-like)
mp4 mp3 * *
	# FT
	[faad] -q -w -f 1 $START$ $END$ $FILE$ | [lame] --silent -q 2 - -

# MP4 -> PCM (fallback)
mp4 pcm * *
	# FT
	[faad] -q -w -f 2 -b 1 $START$ $END$ $FILE$

# =============================================================================
# ALAC (Apple Lossless)
# =============================================================================
# ALAC is stored in MP4 container, needs extraction.

alac mp3 * *
	# FT
	[faad] -q -w -f 1 $START$ $END$ $FILE$ | [lame] --silent -q 2 - -

alac pcm * *
	# FT
	[faad] -q -w -f 2 -b 1 $START$ $END$ $FILE$

# =============================================================================
# Passthrough Formats (no transcoding needed)
# =============================================================================
# These formats are natively supported by all Squeezebox hardware.

mp3 mp3 * *
	-

flac flc * *
	-

flc flc * *
	-

ogg ogg * *
	-

wav wav * *
	-

wav pcm * *
	-

aif aif * *
	-

aif pcm * *
	-

# AAC-ADTS (raw AAC stream, not in MP4 container) is supported
aac aac * *
	-

# WMA is supported on SB2+ (but not SLIMP3)
wma wma squeezebox *
	-

wma wma squeezebox2 *
	-

wma wma transporter *
	-

wma wma boom *
	-

wma wma receiver *
	-

# WMA on SLIMP3 needs transcoding to MP3
wma mp3 slimp3 *
	# F
	[wmadec] -w $FILE$ | [lame] --silent -q 2 - -

# =============================================================================
# FLAC to PCM (for devices that prefer raw PCM)
# =============================================================================

flc pcm * *
	# FT
	[flac] -dcs --force-raw-format --endian=little --sign=signed -- $FILE$

flac pcm * *
	# FT
	[flac] -dcs --force-raw-format --endian=little --sign=signed -- $FILE$

# =============================================================================
# OGG to PCM (fallback)
# =============================================================================

ogg pcm * *
	# F
	[sox] -q -t ogg $FILE$ -t raw -r 44100 -c 2 -2 -s -

# =============================================================================
# Opus (not supported on legacy hardware)
# =============================================================================

opus flc * *
	# F
	[sox] -t opus $FILE$ -t flac -C 0 -

opus pcm * *
	# F
	[sox] -q -t opus $FILE$ -t raw -r 44100 -c 2 -2 -s -

ops flc * *
	# F
	[sox] -t opus $FILE$ -t flac -C 0 -

ops pcm * *
	# F
	[sox] -q -t opus $FILE$ -t raw -r 44100 -c 2 -2 -s -
